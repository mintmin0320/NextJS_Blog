---
title: 'Nestì—ì„œ FormDataë¥¼ ì´ìš©í•´ ì „ì†¡ë°›ì€ ì´ë¯¸ì§€ì™€ ë°ì´í„° ì²˜ë¦¬í•˜ê¸°'
date: '2023-06-08'
tags: ['Nest.js']
draft: false
summary: 'Nest í”„ë ˆì„ì›Œí¬ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ ì´ë¯¸ì§€ì™€ ë°ì´í„° ì²˜ë¦¬í•˜ê¸°'
images: ['/static/images/thumbnail/nest.webp']
---

ê³µìœ  ì˜¤í”¼ìŠ¤ë¥¼ ë“±ë¡í•˜ê³  ì˜ˆì•½í•˜ëŠ” í”„ë¡œì íŠ¸ì—ì„œ íšŒì˜ì‹¤ ë“±ë¡ì„ ìœ„í•œ APIë¥¼ êµ¬í˜„í•˜ë˜ ì¤‘ ì´ë¯¸ì§€ì™€ ë°ì´í„°ë¥¼ ê°™ì´ ì „ì†¡í•˜ëŠ” ë°©ë²•ê³¼ Nest í”„ë ˆì„ì›Œí¬ì—ì„œ ì´ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ê³ ë¯¼ì´ ë§ì•˜ë‹¤. êµ¬ê¸€ì— ì–´ë–¤ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ì•¼ í• ì§€ ëª°ë¼ í—¤ë§¤ë‹¤ê°€ íŠ¸ë ˆì´ë‹ ê°•ì‚¬ë‹˜ê»˜ ì¡°ì–¸ì„ ì–»ì–´ ë³´ê³  ì‹œë„í•´ ë³¸ ê²°ê³¼ë¥¼ ê³µìœ í•´ ë³´ë ¤ê³  í•œë‹¤.
(ì´ë¯¸ì§€ëŠ” S3ì— ì €ì¥ë˜ê³  ê²½ë¡œë§Œ DBì— ì €ì¥)

### ì¤€ë¹„ë¬¼

> - Nest.js - MVCì™€ Repository íŒ¨í„´ì„ ì¤€ìˆ˜í•œ ë””ë ‰í† ë¦¬(...)
> - Postman
> - VS Code
> - S3 (S3ì— ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ê³  DBì—ëŠ” ì´ë¯¸ì§€ ê²½ë¡œë§Œ ì €ì¥)

![](https://velog.velcdn.com/images/mintmin0320/post/3b3b35f5-a344-463a-8275-d29cb9be2f0c/image.png)

ìœ„ ì‚¬ì§„ê³¼ ê°™ì´ ê³µìœ  ì˜¤í”¼ìŠ¤ë¥¼ ë“±ë¡í•˜ëŠ” ê¸°ëŠ¥ì„ ë§Œë“œëŠ” ê²ƒì´ ëª©ì ì´ë‹¤. ( ì•„ì§ í”„ë¡ íŠ¸ ë¯¸ì™„ì„±ìœ¼ë¡œ Postmanì„ ì‚¬ìš© )

## Multer

```
npm i -D @types/multer
```

- Expressì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ ëª¨ë“ˆì„ ì œê³µí•´ì£¼ëŠ” íŒ¨í‚¤ì§€
- ìš”ì²­ê³¼ í•¸ë“¤ëŸ¬ ì‚¬ì´ì—ì„œ íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´
- ê¸°ë³¸ì ìœ¼ë¡œ Nestì— ë‚´ì¥ë˜ì–´ ìˆì–´ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ëª…ì‹œ

<br />

## Controller

```
controller.ts

import { Body, Controller, Get, Post, UploadedFile, UseInterceptors } from '@nestjs/common';
import { CreateReservationDto } from '../dto/create-reservation.dto';
import { ReservationService } from '../services/reservation.service';
import { FileInterceptor } from '@nestjs/platform-express';

@Controller('reservation')
export class ReservationController {
  constructor(
    private readonly reservationService: ReservationService,
  ) { }

  @Post('set-office')
  @UseInterceptors(FileInterceptor('image'))
  async create(@UploadedFile() file: Express.Multer.File, @Body() reservationDto: CreateReservationDto) {
    return await this.reservationService.create('reservation', file, reservationDto);
  }
}
```

ì£¼ìš” ì½”ë“œë§Œ ì‚´í´ë³´ë©´

```
@UseInterceptors(FileInterceptor('image'))
```

FileInterceptor('file')

- ì»¨íŠ¸ë¡¤ëŸ¬ì— ì¸í„°ì…‰í„° ì ìš©ì„ ìœ„í•´ @UseInterceptors ë°ì½”ë ˆì´ì…˜ì„ ì‚¬ìš©
- í•˜ë‚˜ì˜ íŒŒì¼ì„ ë°›ì„ë•Œ ì‚¬ìš©í•˜ëŠ” ì¸í„°ì…‰í„°
- ì²« ë²ˆì§¸ file ë³€ìˆ˜ì˜ íŒŒì¼ ì •ë³´ë¥¼ ë°›ì•„ ì˜¨ë‹¤.
- ('file')ì˜ ê²½ìš° í”„ë¡ íŠ¸ì—ì„œ ì „ì†¡í•  ë–„ FormDataì—ì„œ ì„¤ì •í•œ nameê³¼ ë™ì¼í•´ì•¼ í•¨
  ( í”„ë¡ íŠ¸ì—ì„œ 'image'ë¡œ ë³´ë‚¼ ê²½ìš° 'image'ë¡œ ë¬´ì¡°ê±´ ì ì–´ì¤˜ì•¼ í•¨ )
- ì—¬ëŸ¬ ê°œì˜ ì´ë¯¸ì§€ë¥¼ ë°›ìœ¼ë ¤ë©´ FilesInterceptorë¥¼ ì‚¬ìš©

<br />

```
  async create(@UploadedFile() file: Express.Multer.File, @Body() reservationDto: CreateReservationDto) {
    return await this.reservationService.create('reservation', file, reservationDto);
  }
```

- fileì˜ íƒ€ì…ì€ Express.Multer.File
- CreateReservationDtoì—ëŠ” íšŒì˜ì‹¤ëª…, ì§€ì—­, ë¹„ìš© ë“±ì˜ ì •ë³´

![](https://velog.velcdn.com/images/mintmin0320/post/d5c9c8cc-c24c-4417-909a-ef6f2337a3e1/image.png)

```
this.reservationService.create('reservation', file, reservationDto);
```

ì„œë¹„ìŠ¤ì— createí•¨ìˆ˜ë¡œ ë„˜ê¸°ëŠ” ì¸ì

- 'reservation'
  ì´ë¯¸ì§€ë¥¼ AWS S3ì— ì €ì¥í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì €ì¥ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë‹´ëŠ” ë²„í‚· í´ë”ëª…ì„ ì§€ì •í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰

file

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ë‹¬ë°›ì„ ì´ë¯¸ì§€ ì •ë³´ê°€ ë‹´ê¸´ íŒŒì¼

reservationDto

- íšŒì˜ì‹¤ ì „í™”ë²ˆí˜¸, ì§€ì—­, ê°€ê²© ë“±ì˜ ì •ë³´

## Service

```
service.ts

import { BadRequestException, Injectable } from '@nestjs/common';
import * as AWS from 'aws-sdk';
import * as path from 'path';

import { ReservationRepository } from '../repository/reservation.repository';
import { CreateReservationDto } from './../dto/create-reservation.dto';


@Injectable()
export class ReservationService {
  private readonly awsS3: AWS.S3;
  public readonly S3_BUCKET_NAME: string

  constructor(
    private readonly reservationRepository: ReservationRepository
  ) {
    this.awsS3 = new AWS.S3({
      accessKeyId: process.env.AWS_S3_ACCESS_KEY,
      secretAccessKey: process.env.AWS_S3_SECRET_KEY,
      region: process.env.AWS_S3_REGION,
    });
    this.S3_BUCKET_NAME = process.env.AWS_S3_BUCKET_NAME;
  }

  async create(folder: string, file: Express.Multer.File, reservationDto: CreateReservationDto) {
    try {
      const key = `${folder}/${Date.now()}_${path.basename(
        file.originalname,
      )}`.replace(/ /g, '');

      await this.awsS3
        .putObject({
          Bucket: this.S3_BUCKET_NAME,
          Key: key,
          Body: file.buffer,
          ACL: 'public-read',
          ContentType: file.mimetype,
        })
        .promise();

      const imgUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.amazonaws.com/${key}`;

      const result = await this.reservationRepository.create(imgUrl, reservationDto);

      return result;
    } catch (error) {
      throw new BadRequestException(`File upload failed : ${error}`);
    }
  }
}
```

ì´ë¯¸ì§€ë¥¼ S3ë¡œ ì €ì¥í•˜ëŠ” ì½”ë“œëŠ” ìƒëµí•˜ê³  ì§‘ì¤‘ì ìœ¼ë¡œ ë´ì•¼ í•  ë¶€ë¶„ì€ imgUrlê³¼ reservationDtoì„ reservationRepositoryì— createë¡œ ì¸ìë¥¼ ì „ë‹¬í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.

```
const result = await this.reservationRepository.create(imgUrl, reservationDto);
```

imgUrl

- ì´ë¯¸ì§€ê°€ ì €ì¥ëœ ê²½ë¡œ

reservationDto

- íšŒì˜ì‹¤ ì „í™”ë²ˆí˜¸, ì§€ì—­, ê°€ê²© ë“±ì˜ ì •ë³´

<br />

## Repository

```
repository

import { BadRequestException, Injectable } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { Reservation } from '../reservation.schema';
import { CreateReservationDto } from '../dto/create-reservation.dto';


@Injectable()
export class ReservationRepository {
  constructor(
    @InjectModel(Reservation.name) private readonly reservationModel: Model<Reservation>,
  ) { }

  async create(imgUrl: string, reservationDto: CreateReservationDto) {
    const { telNum, pay, placeName, decrition, areaName, detailAdress } = reservationDto
    try {
      await this.reservationModel.create({ telNum, pay, placeName, decrition, areaName, detailAdress, imgUrl });

      return { result: true, message: "íšŒì˜ì‹¤ ë“±ë¡ ì„±ê³µ" };
    } catch (error) {
      throw new BadRequestException(`File upload failed : ${error}`);
    }
  }
}
```

í•œ ì¤„ì”© ì‚´í´ë³´ì

```
async create(imgUrl: string, reservationDto: CreateReservationDto) {
    const { telNum, pay, placeName, decrition, areaName, detailAdress } = reservationDto
}
```

ì„œë¹„ìŠ¤ì—ì„œ imgUrlê³¼ reservationDtoì„ ì „ë‹¬ë°›ì•„ reservationDtoì„ êµ¬ì¡° ë¶„í•´ í• ë‹¹í•˜ê³ 

```
try {
  await this.reservationModel.create({ telNum, pay, placeName, decrition, areaName, detailAdress, imgUrl });

  return { result: true, message: "íšŒì˜ì‹¤ ë“±ë¡ ì„±ê³µ" };
} catch (error) {
  throw new BadRequestException(`File upload failed : ${error}`);
}
```

ë¶„í•´ëœ ê°ì²´ ë°ì´í„°ì™€ imgUrlì„ create ë©”ì†Œë“œë¥¼ ì´ìš©í•´ ìƒì„±í•´ì£¼ë©´ ëœë‹¤.

<br />

## PostManì„ ì´ìš©í•œ í…ŒìŠ¤íŠ¸

![](https://velog.velcdn.com/images/mintmin0320/post/c3e82ab2-6733-4063-b8f5-54741b69c0d3/image.png)

(office.jpeg)
![](https://velog.velcdn.com/images/mintmin0320/post/01d1f8f0-01fb-42c2-9ad0-65e2c6da375f/image.png)íšŒì˜ì‹¤ ì‚¬ì§„ì„ ë°ì´í„°ì™€ í•¨ê»˜ form-data ê°ì²´ì— ë‹´ì•„ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.

![](https://velog.velcdn.com/images/mintmin0320/post/8ef0e8de-7aeb-4e85-9285-33e583246590/image.png)í¬ìŠ¤íŠ¸ë§¨ì„ í™•ì¸í•´ë³´ë©´ ì •ìƒì ì¸ ì‘ë‹µì„ ë°›ì•˜ê³ 

![](https://velog.velcdn.com/images/mintmin0320/post/772d85d0-b3a6-469f-8150-911aeb55ac90/image.png) DBì—ì„œë„ ì •ìƒì ìœ¼ë¡œ ë°ì´í„°ê°€ ì €ì¥ëë‹¤.

![](https://velog.velcdn.com/images/mintmin0320/post/a7994760-afa9-4174-868f-371e56dc8f2d/image.png) ì´ë¯¸ì§€ ê²½ë¡œë„ ì •ìƒì ìœ¼ë¡œ ì ‘ì†ë¼ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤ ( ì´ìƒí•´ ë³´ì´ì§€ë§Œ ì •ìƒì´ë‹¤.. )

<br />

## í›„ê¸°

í”„ë¡œí•„ ì‚¬ì§„ ê¸°ëŠ¥ êµ¬í˜„ì„ ìœ„í•´ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œëŠ” í•´ë´¤ì§€ë§Œ ë°ì´í„°ì™€ ì´ë¯¸ì§€ë¥¼ ë„˜ê¸°ëŠ” ë°©ë²•ì€ ì²˜ìŒ ì‚¬ìš©í•´ ë´¤ê¸° ë•Œë¬¸ì— í¬ìŠ¤íŒ…í•˜ê¸°ì— ì¢‹ì€ ì£¼ì œë¼ê³  ìƒê°í•´ í¬ìŠ¤íŒ… í•˜ê²Œ ëë‹¤. êµ¬ê¸€ì— ì–´ë–¤ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ì„ í•´ì•¼ í• ì§€ ëª°ë¼ì„œ ê·¸ëŸ°ì§€ëŠ” ëª°ë¼ë„ ì›í•˜ëŠ” ê²€ìƒ‰ ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ëŠ” ì•Šì•˜ê¸° ë•Œë¬¸ì— ê°™ì€ ê³ ë¯¼ì„ í•˜ëŠ” ë¶„ë“¤ì—ê²Œ ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤.
(ë„ì›€ì„ ì£¼ì‹  ì¡´ ì•ˆ ê°•ì‚¬ë‹˜ ê°ì‚¬í•©ë‹ˆë‹¤..)
ì•¼ê°„ ìˆ˜ì—…ì´ ëë‚˜ê³ .. 1ì‹œê°€ ì¡°ê¸ˆ ë„˜ì—ˆì§€ë§Œ ì˜¤ëŠ˜ì€ ê¼­ í¬ìŠ¤íŒ…ì„ í•˜ê² ë‹¤ê³  ë‹¤ì§í–ˆê¸° ë•Œë¬¸ì— ì¡¸ìŒì„ ì°¸ìœ¼ë©° ê¸€ì„ ì‘ì„±í•˜ê³  ìˆë‹¤. í¬ìŠ¤íŒ…ì„ í•  ë•Œë§ˆë‹¤ ëŠë¼ëŠ” ê±´ ìƒê°ë³´ë‹¤ ë¿Œë“¯í•˜ê³  ë³´ëŒì°¨ë‹¤ ì•ìœ¼ë¡œë„ ëª¨ë¥´ëŠ” ë‚´ìš©ì´ë‚˜ ê¸°ë¡í•  ë§Œí•œ ë‚´ìš©ì´ ìƒê¸´ë‹¤ë©´ ë˜ í¬ìŠ¤íŒ…ì„ í•˜ê² ë‹¤ëŠ” ë‹¤ì§ì„ í•˜ë©° ë‚´ì¼ ë¶€ìº ì„ ìœ„í•´ ê¸€ì„ ë§ˆì¹˜ê² ë‹¤!

<br />
<br />

## ğŸš€Error Report

1. ì²˜ìŒ ì´ë¯¸ì§€ íŒŒì¼ê³¼ ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ì…ë ¥ë°›ì•„ì•¼ í• ì§€ ê³ ë¯¼ì„ ë§ì´ í–ˆë‹¤. ì²˜ìŒ ì‹œë„í•œ ë°©ë²•ì€ formìœ¼ë¡œ ì´ë¯¸ì§€ì™€ ë°ì´í„°ë¥¼ ëª¨ë‘ ì „ë‹¬ë°›ëŠ” ë°©ë²•ì„ ì‹œë„í–ˆì§€ë§Œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. ê²°êµ­ ì¡°ì–¸ì„ ë°›ê³  ì•Œì•„ë‚¸ ë°©ë²•ì€ formdata.appendë¡œ key, value í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ ê°„ë‹¨í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.<br/> ( ex. formdata.append(placeName: "ë™ì–‘ íšŒì˜ì‹¤") )

2. create() ì•ˆì— { }(ì¤‘ê´„í˜¸)ë¥¼ ìƒëµí•´ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì—ˆë‹¤.

```
await this.reservationModel.create( telNum, pay, placeName, decrition, areaName, detailAdress, imgUrl);
```
